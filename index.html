<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>旅遊行程 — 武漢 張家界</title>
  <link rel="stylesheet" href="style.css" />
  <!-- marked.js 用於把 Markdown 轉成 HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header>
    <h1 id="page-title">旅遊行程</h1>
    <div class="toolbar">
      <a id="edit-on-github" target="_blank" rel="noopener">在 GitHub 編輯</a>
      <a id="open-repo" target="_blank" rel="noopener">到 Repo</a>
    </div>
  </header>

  <main>
    <!-- 側邊選單 -->
    <nav id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <h3>目錄</h3>
        <button id="menu-toggle" class="menu-toggle" aria-label="切換選單">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="table-of-contents" class="toc">
        <!-- 動態產生的目錄將會插入這裡 -->
      </div>
    </nav>
    
    <!-- 主要內容區 -->
    <div class="content-wrapper">
      <article id="content">載入中...</article>
    </div>
    
    <!-- 行動裝置遮罩 -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
  </main>

  <footer>
    <small>若想新增/編輯：請在 GitHub 上修改 `武漢張家界.md` 或上傳圖片到 `/images`。</small>
  </footer>

<script>
(async function(){
  // 設定要讀取的 Markdown 檔名（放在 repo 根目錄）
  const mdFile = '武漢張家界.md';

  // 區域：根據目前 URL 推斷 GitHub repo 位置（使用者之後可按按鈕手動設定）
  // 預設值（若你不在 GitHub Pages 頁面直接打開，請手動點 "到 Repo" 設定）
  const repoInfo = {
    user: '', // 在此填入 GitHub 使用者或組織名（選填，若空白則 edit 連結不會正確）
    repo: ''  // Repo 名稱
  };

  // 更新 toolbar 連結（如果 repo 設定了會顯示 edit 連結）
  const editBtn = document.getElementById('edit-on-github');
  const repoBtn = document.getElementById('open-repo');
  if (repoInfo.user && repoInfo.repo) {
    const base = `https://github.com/${repoInfo.user}/${repoInfo.repo}`;
    editBtn.href = base + `/edit/main/${encodeURIComponent(mdFile)}`;
    editBtn.textContent = '在 GitHub 編輯（建議）';
    repoBtn.href = base;
    repoBtn.textContent = '打開 Repo';
  } else {
    editBtn.href = '#';
    editBtn.addEventListener('click', ()=> alert('請先在 index.html 中填入 repoInfo.user 與 repoInfo.repo，或直接用 GitHub 上傳/編輯檔案。'));
    repoBtn.href = '#';
  }

  try {
    // 以相對路徑 fetch，同一 repo 的 GitHub Pages 可以直接讀取
    const r = await fetch('./' + mdFile);
    if (!r.ok) throw new Error('讀取 Markdown 檔失敗');
    const md = await r.text();

    // 轉 Markdown -> HTML
    const html = marked.parse(md, { gfm: true, breaks: true });

    document.getElementById('content').innerHTML = html;

    // 可選：把第一個 h1 設為 page title
    const firstH1 = document.querySelector('#content h1');
    if (firstH1) document.getElementById('page-title').textContent = firstH1.textContent;

    // 產生目錄
    generateTableOfContents();

  } catch (err) {
    document.getElementById('content').textContent = '載入行程失敗：' + err.message;
  }

  // 產生目錄函式
  function generateTableOfContents() {
    const headings = document.querySelectorAll('#content h2, #content h3');
    const toc = document.getElementById('table-of-contents');
    
    if (headings.length === 0) {
      toc.innerHTML = '<p class="no-headings">未找到標題</p>';
      return;
    }

    let tocHTML = '<ul class="toc-list">';
    let currentLevel = 2;
    
    headings.forEach((heading, index) => {
      const level = parseInt(heading.tagName.charAt(1));
      const id = `heading-${index}`;
      const text = heading.textContent;
      
      // 為標題加上 id
      heading.id = id;
      
      // 處理層級變化
      if (level > currentLevel) {
        // 開啟子層級
        for (let i = currentLevel; i < level; i++) {
          tocHTML += '<ul class="toc-sublist">';
        }
      } else if (level < currentLevel) {
        // 關閉子層級
        for (let i = currentLevel; i > level; i--) {
          tocHTML += '</ul>';
        }
      }
      
      tocHTML += `<li class="toc-item toc-level-${level}">
        <a href="#${id}" class="toc-link" data-level="${level}">${text}</a>
      </li>`;
      
      currentLevel = level;
    });
    
    // 關閉所有開啟的層級
    for (let i = currentLevel; i >= 2; i--) {
      tocHTML += '</ul>';
    }
    
    toc.innerHTML = tocHTML;
    
    // 加入點擊事件
    const tocLinks = document.querySelectorAll('.toc-link');
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth' });
          
          // 在行動裝置上自動關閉選單
          if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebar-overlay').classList.remove('active');
          }
        }
      });
    });
  }

  // 選單切換功能
  const menuToggle = document.getElementById('menu-toggle');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');

  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    menuToggle.classList.toggle('active');
  });

  overlay.addEventListener('click', () => {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    menuToggle.classList.remove('active');
  });

  // 視窗大小改變時的處理
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      menuToggle.classList.remove('active');
    }
  });
})();
</script>
</body>
</html>